@page "/"
@using MercerVoice.Services
@inject IDictationService DictationService
@inject IJSRuntime JS
@implements IDisposable

<div class="pill-overlay @StateClass">
    @switch (_state)
    {
        case DictationState.Idle:
            <div class="pill-idle">
                <svg class="pill-mic-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" x2="12" y1="19" y2="22"/>
                </svg>
                <span class="pill-label">MercerVoice</span>
            </div>
            break;

        case DictationState.Recording:
            <div class="pill-recording">
                <span class="recording-indicator"></span>
                <canvas id="waveformCanvas" width="220" height="40"></canvas>
                <span class="pill-duration">@FormatDuration(_recordingSeconds)</span>
            </div>
            break;

        case DictationState.Transcribing:
            <div class="pill-transcribing">
                <div class="transcribing-dots">
                    <span></span><span></span><span></span>
                </div>
                <span class="pill-label">Transcribing</span>
            </div>
            break;

        case DictationState.Typing:
            <div class="pill-typing">
                <svg class="pill-check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                <span class="pill-label">Done</span>
            </div>
            break;

        case DictationState.Error:
            <div class="pill-error">
                <span class="pill-error-badge">!</span>
                <span class="pill-label">Error</span>
            </div>
            break;
    }
</div>

@code {
    private DictationState _state = DictationState.Idle;
    private int _recordingSeconds;
    private System.Timers.Timer? _durationTimer;

    private string StateClass => _state switch
    {
        DictationState.Idle => "state-idle",
        DictationState.Recording => "state-recording",
        DictationState.Transcribing => "state-transcribing",
        DictationState.Typing => "state-typing",
        DictationState.Error => "state-error",
        _ => ""
    };

    protected override void OnInitialized()
    {
        DictationService.StateChanged += OnStateChanged;
        DictationService.AudioLevelChanged += OnAudioLevelChanged;
    }

    private void OnStateChanged(DictationState newState)
    {
        _state = newState;

        if (newState == DictationState.Recording)
        {
            _recordingSeconds = 0;
            StartDurationTimer();
        }
        else
        {
            StopDurationTimer();
            try { _ = JS.InvokeVoidAsync("waveform.reset"); } catch { }
        }

        InvokeAsync(StateHasChanged);
    }

    private async void OnAudioLevelChanged(float level)
    {
        try
        {
            await JS.InvokeVoidAsync("waveform.pushLevel", level);
        }
        catch { }
    }

    private void StartDurationTimer()
    {
        _durationTimer = new System.Timers.Timer(1000);
        _durationTimer.Elapsed += (_, _) =>
        {
            _recordingSeconds++;
            InvokeAsync(StateHasChanged);
        };
        _durationTimer.Start();
    }

    private void StopDurationTimer()
    {
        _durationTimer?.Stop();
        _durationTimer?.Dispose();
        _durationTimer = null;
    }

    private static string FormatDuration(int seconds) => $"{seconds / 60}:{seconds % 60:D2}";

    public void Dispose()
    {
        DictationService.StateChanged -= OnStateChanged;
        DictationService.AudioLevelChanged -= OnAudioLevelChanged;
        StopDurationTimer();
    }
}
